name: Weekly Credibility Resolution

on:
  schedule:
    # Run every Monday at 4am UTC
    - cron: '0 4 * * 1'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  resolve-credibility:
    name: Apply Weekly Credibility Bonuses/Penalties
    runs-on: ubuntu-latest

    steps:
      - name: Run weekly credibility resolution function
        run: |
          echo "Running weekly credibility resolution..."

          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST \
            "${{ secrets.SUPABASE_URL }}/rest/v1/rpc/apply_weekly_credibility_resolution" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json")

          http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d: -f2)
          body=$(echo "$response" | sed -e 's/HTTP_STATUS\:.*//g')

          echo "Response: $body"
          echo "HTTP Status: $http_status"

          if [ "$http_status" -ne 200 ]; then
            echo "Error: Weekly credibility resolution failed with status $http_status"
            exit 1
          fi

          echo "Weekly credibility resolution completed successfully!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Weekly credibility resolution failed!"
          echo "Check the logs above for details."
