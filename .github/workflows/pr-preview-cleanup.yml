name: PR Preview Database Cleanup

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    name: Delete Preview Database Schema
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    steps:
      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Generate schema name
        id: schema
        run: |
          SCHEMA_NAME="pr_${{ github.event.pull_request.number }}"
          echo "name=${SCHEMA_NAME}" >> $GITHUB_OUTPUT
          echo "ðŸ—‘ï¸  Schema to delete: ${SCHEMA_NAME}"

      - name: Link to dev project
        run: supabase link --project-ref vuoucahoqaxpudtbdzjf
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_DEV_ACCESS_TOKEN }}

      - name: Delete preview schema
        run: |
          SCHEMA_NAME="${{ steps.schema.outputs.name }}"

          echo "ðŸ”¥ Deleting schema: ${SCHEMA_NAME}"
          cat > /tmp/cleanup.sql << EOFCLEANUP
          DROP SCHEMA IF EXISTS $SCHEMA_NAME CASCADE;
          EOFCLEANUP

          supabase db execute --file /tmp/cleanup.sql --linked

          echo "âœ… Preview database cleaned up"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const schema = '${{ steps.schema.outputs.name }}';

            const body = `## ðŸ§¹ Preview Database Cleaned Up

            The preview database schema \`${schema}\` has been deleted.

            ${{ github.event.pull_request.merged && 'âœ… Changes merged to main!' || 'âŒ PR closed without merging.' }}
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
